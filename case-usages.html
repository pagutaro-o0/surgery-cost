<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>case-usages</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
 

  <div class="shell">
    <div id="appHeader"></div>

    <div class="content">
      <div class="card">
        <div class="case-head">
  <div class="label">患者ID</div>
  <div class="input" id="hPatient" style="display:flex; align-items:center;"></div>

  <div class="label">診療科</div>
  <div class="input" id="hDept" style="display:flex; align-items:center;"></div>

  <div class="label">手術日</div>
  <div class="input" id="hDate" style="display:flex; align-items:center;"></div>

  <div class="label">年齢</div>
  <div class="input" id="hAge" style="display:flex; align-items:center;"></div>

  <!-- 術式：値だけ右へ長く伸ばす -->
  <div class="label">術式</div>
  <div class="input wide-proc" id="hProc" style="display:flex; align-items:center;"></div>
</div>

        <div style="margin-top:14px; display:flex; gap:10px;">
          <button class="btn blue small" id="btnAdd">行を追加</button>
          <button class="btn blue" id="btnSave">保存</button>
          <button class="btn secondary" id="btnBack">戻る</button>
        </div>
      </div>

      <div class="h2">患者消耗品一覧</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:52%;">消耗品</th>
              <th style="width:12%;">使用量</th>
              <th style="width:12%;">単位</th>
              <th style="width:24%;">メモ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <script src="./app.js"></script>
  <script>
    seedIfEmpty();
    renderAppHeader({ active: "cases" });

    const caseId = getUrlParam("case_id");
    if(!caseId){
      alert("case_id が指定されていません（患者一覧の「表示」から開いてください）");
      location.href = "./cases.html";
      throw new Error("missing case_id");
    }

    // ★ 文字列化して比較（型ズレ対策）
    const c = getCases().find(x => String(x.case_id) === String(caseId));
    if(!c){
      alert("症例が見つかりません（インポート後に一覧から開き直してください）");
      location.href = "./cases.html";
      throw new Error("case not found");
    }

    // ヘッダ表示
    qs("#hPatient").textContent = `${c.patient_id ?? ""}  ${c.patient_name ?? ""}`;
    qs("#hDept").textContent = c.dept ?? "";
    qs("#hDate").textContent = toJPDate(c.surg_date);

    qs("#hProc").textContent = c.surg_procedure ?? "";
    qs("#hAge").textContent = (c.age ?? "") === "" ? "" : `${c.age}歳`;

    const tbody = qs("#tbody");

    function makeRow(line){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="input item" value="${line.item_name ?? ""}" style="height:46px;"></td>
        <td class="center"><input class="input qty" type="number" min="0" step="1" value="${line.quantity ?? 1}" style="height:46px; text-align:center;"></td>
        <td class="center"><input class="input unit" value="${line.unit ?? "本"}" style="height:46px; text-align:center;"></td>
        <td><input class="input memo" value="${line.memo ?? ""}" style="height:46px;"></td>
      `;
      return tr;
    }

    function loadLines(){
  const lines = getUsageByCaseId(caseId);
  tbody.innerHTML = "";

  // 既に保存済みがあればそれを表示
  if(lines.length > 0){
    lines.forEach(l=> tbody.appendChild(makeRow(l)));
    return;
  }

  // ★抽出（症例の remarks から）
  const stars = extractStarNameQty(c.remarks || "");

  // ★があればその分の行を作る
  if(stars.length > 0){
    stars.forEach(s=>{
      tbody.appendChild(makeRow({ item_name: s.name, quantity: s.qty, unit:"本", memo:"★抽出" }));
    });
    return;
  }

  // ★が無ければ空行1つ
  tbody.appendChild(makeRow({ item_name:"", quantity:1, unit:"本", memo:"" }));
}

    function collect(){
      return qsa("#tbody tr").map(tr=>({
        item_name: tr.querySelector(".item").value,
        quantity: Number(tr.querySelector(".qty").value) || 0,
        unit: tr.querySelector(".unit").value,
        memo: tr.querySelector(".memo").value
      }));
    }

    qs("#btnAdd").addEventListener("click", ()=>{
      tbody.appendChild(makeRow({ item_name:"", quantity:1, unit:"本", memo:"" }));
    });

    qs("#btnSave").addEventListener("click", ()=>{
      setUsageForCaseId(caseId, collect());
      alert("保存しました");
    });

    qs("#btnBack").addEventListener("click", ()=> location.href="./cases.html");

    loadLines();
    function extractStarNameQty(text){
  const t = String(text || "");
  const re = /★\s*([^\n★]+)/g;
  const out = [];
  let m;

  while((m = re.exec(t)) !== null){
    const block = m[1].trim();
    const name = block.split("[[")[0].split(",")[0].trim();

    let qty = 1;
    const q = block.match(/\[\[\s*\[?\s*(\d+)\s*\]?\s*[^\]]*\]\]/);
    if(q) qty = Number(q[1]);

    if(name) out.push({ name, qty });
  }

  // 同名は合算
  const map = new Map();
  for(const x of out){
    map.set(x.name, (map.get(x.name) || 0) + x.qty);
  }
  return Array.from(map.entries()).map(([name, qty]) => ({ name, qty }));
}
  </script>
</body>
</html>