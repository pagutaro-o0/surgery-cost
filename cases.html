<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>患者一覧</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="page-title">cases.html</div>

  <div class="shell">
    <div id="appHeader"></div>

    <div class="content">
      <div class="card">
        <div class="filters">
          <div class="label">開始日</div>
          <input class="input" type="date" id="startDate" />

          <div class="label">終了日</div>
          <input class="input" type="date" id="endDate" />

          <div class="label">診療科</div>
          <select class="input" id="dept"></select>

          <div class="label">削除フラグ</div>
          <label style="display:flex; align-items:center; gap:10px; background:white; border:2px solid var(--border); height:48px; padding:0 12px;">
            <input type="checkbox" id="showDeleted" style="width:20px; height:20px;">
            <span style="font-weight:900;">表示する</span>
          </label>

          <button class="btn secondary" id="btnRefresh" style="grid-column: 1 / span 2;">画面更新</button>
        </div>
      </div>

      <div class="h2">手術一覧</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:12%;">実施日</th>
              <th style="width:14%;">患者番号</th>
              <th style="width:16%;">氏名</th>
              <th style="width:8%;">年齢</th>
              <th style="width:14%;">診療科</th>
              <th style="width:18%;">病名</th>
              <th style="width:14%;">術式</th>
              <th style="width:4%;"></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>
<script src="./app.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tbody      = document.querySelector("#tbody");
    const startDate  = document.querySelector("#startDate");
    const endDate    = document.querySelector("#endDate");
    const dept       = document.querySelector("#dept");
    const showDeleted = document.querySelector("#showDeleted");
    const btnRefresh = document.querySelector("#btnRefresh");

    // 取得した全症例をここに保持
    let allCases = [];

    // 日付を YYYY-MM-DD → YYYY/MM/DD に軽く整形（空なら空文字）
    function toJPDate(dateStr) {
      if (!dateStr) return "";
      return String(dateStr).replace(/-/g, "/");
    }

    // 診療科セレクトボックスを作る
    function buildDeptOptions() {
      const set = new Set(allCases.map(c => c.dept).filter(Boolean));
      const list = Array.from(set).sort((a, b) => a.localeCompare(b));

      dept.innerHTML =
        `<option value="">（すべて）</option>` +
        list.map(d => `<option value="${d}">${d}</option>`).join("");
    }

    // フィルタ条件に従ってテーブルを描画
    function render() {
      const s = startDate.value || "0000-01-01";
      const e = endDate.value   || "9999-12-31";
      const d = dept.value || "";
      const showDel = showDeleted.checked;

      const filtered = allCases.filter(c => {
        const date = String(c.surg_date || "");
        const okDate = (date >= s && date <= e);
        const okDept = (!d || c.dept === d);
        // deleted フラグは現状 DB に無いので、常に「削除されていない」扱いにする
        const okDel  = showDel ? true : !c.deleted;
        return okDate && okDept && okDel;
      });

      tbody.innerHTML = "";
      filtered.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center">${toJPDate(c.surg_date)}</td>
          <td class="center">${c.patient_id ?? ""}</td>
          <td class="center">${c.patient_name ?? ""}</td>
          <td class="center">${c.age ?? ""}</td>
          <td class="center">${c.dept ?? ""}</td>
          <td>${c.disease ?? ""}</td>
          <td>${c.surg_procedure ?? ""}</td>
          <td class="actions">
            <button type="button" class="btn linklike" data-open="${c.case_id}">
              <span class="highlight">表示</span>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 行が少ないときの見た目調整（空行を足す）
      const minRows = 6;
      for (let i = filtered.length; i < minRows; i++) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
        tbody.appendChild(tr);
      }
    }

    // 「画面更新」ボタン
    btnRefresh.addEventListener("click", () => {
      buildDeptOptions();
      render();
    });

    // 日付・診療科・削除フラグの変更で自動再描画
    [startDate, endDate, dept, showDeleted].forEach(el => {
      el.addEventListener("change", render);
    });

    // 行の「表示」クリックで case-usages.html に遷移
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-open]");
      if (!btn) return;

      const caseId = btn.getAttribute("data-open");
      const url = `./case-usages.html?case_id=${encodeURIComponent(caseId)}`;
      console.log("open case", caseId, "=>", url);
      location.href = url;
    });

    // 初回ロード：API から症例一覧を取得
    async function loadCases() {
      try {
        const res = await fetch("/api/cases");
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.error || "症例一覧の取得に失敗しました");
        }

        allCases = data.cases || [];
        buildDeptOptions();
        render();
      } catch (err) {
        console.error(err);
        alert(err.message || err);
      }
    }

    loadCases();
  });
</script>
</body>
</html>